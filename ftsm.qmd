---
title: "Financial Time Series Models(ARCH/GARCH)"
author: "Ke Tian"
format: 
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    echo: true
    message: false
    warning: false
---

# Financial Time Series Models(ARCH/GARCH)

Natural gas prices are known for their frequent and sometimes sharp fluctuations, often driven by seasonal demand, supply conditions, and geopolitical events. These changes don’t just impact the commodity market—they can also affect companies that rely on natural gas as a key input. Duke Energy (DUK), one of the largest utility companies in the U.S., uses a significant amount of natural gas for power generation. This makes it a good candidate to explore whether movements in natural gas prices might also show up in the behavior of its stock returns.

To better understand the nature of these fluctuations, we apply ARCH and GARCH models to both natural gas returns and DUK stock returns. These models are designed to capture volatility clustering—periods of calm followed by periods of turbulence—which is common in financial and commodity markets. By comparing the volatility patterns in both series, we aim to see whether there’s a shared structure or potential spillover in risk, which could have implications for investors and risk managers in energy-related sectors.

## Import package

```{r}
library(quantmod)
library(tidyverse)
library(PerformanceAnalytics)
library(tseries)
library(zoo)
library(fGarch)
library(forecast)
```

# DUK

## Load data and visualization

```{r}
start_date <- as.Date("2010-01-01")
end_date <- Sys.Date()

getSymbols("DUK", from = start_date, to = end_date, src = "yahoo")

duk_price <- Cl(DUK)
duk_return <- na.omit(dailyReturn(duk_price, type = "log"))

par(mfrow = c(1, 2))
plot(duk_price, main = "Duke Energy Price (DUK)", col = "darkred")
plot(duk_return, main = "DUK Log Return", col = "purple")

roll_sd_duk <- rollapply(duk_return, width = 20, FUN = sd, by = 1, fill = NA)
plot(roll_sd_duk, main = "Rolling Volatility (DUK)", col = "darkred")

cat("ADF Test for DUK Return:\n")
print(adf.test(na.omit(duk_return)))
```

From the log return plot and the rolling volatility plot, it can be observed that the natural gas returns are highly volatile and unstable, especially during the period of severe volatility in the energy market in 2021-2022, when volatility rises rapidly, which is a typical characteristic of volatility clustering.The volatility of DUK stock is relatively mild, but it has a significant jump in early 2020 under the impact of the epidemic, followed by a gradual fall in volatility. Volatility then tapers off, also exhibiting mild volatility aggregation.

## ACF & PACF

```{r}
# acf and pacf of duk
par(mfrow = c(1, 2))
acf(na.omit(duk_return), main = "ACF of DUK Return")
pacf(na.omit(duk_return), main = "PACF of DUK Return")
```

DUK's ACF at lag1 has a significant peak, followed by a rapid decay, so q = 1, p can be 1,2,3,4, and we did not differentiate the data, so d = 0

## ARIMA Model Select

```{r}
ARIMA_c <- function(p_min, p_max, q_min, q_max, data) {
  results <- matrix(nrow = 0, ncol = 6)
  colnames(results) <- c("p", "d", "q", "AIC", "BIC", "AICc")
  
  for (p in p_min:p_max) {
    for (q in q_min:q_max) {
      d <- 0
      fit <- tryCatch({
        Arima(data, order = c(p, d, q))
      }, error = function(e) NULL)
      
      if (!is.null(fit)) {
        metrics <- c(p, d, q, AIC(fit), BIC(fit), fit$aicc)
        results <- rbind(results, metrics)
      }
    }
  }
  
  results_df <- as.data.frame(results)
  colnames(results_df) <- c("p", "d", "q", "AIC", "BIC", "AICc")
  return(results_df)
}

output_duk <- ARIMA_c(0, 4, 0, 1, data = duk_return)

output_duk[which.min(output_duk$AIC), ]
```

Based on the comparison results, the best model we chose is ARIMA (4, 0, 1) because it has the minimum AIC

### auto.arima

```{r}
auto_arima_duk <- auto.arima(duk_return)
summary(auto_arima_duk)
```

The best model we chose using auto.arim was ARIMA (2, 0, 2)

### Model Diagnotic

```{r}
library(astsa)
out_put_401 <- capture.output(sarima(duk_return, 4, 0, 1))
```

```{r}
out_put_202 <- capture.output(sarima(duk_return, 2, 0, 2))
```

### Compareation

```{r}
extract_model_summary <- function(model_output, label = "") {
  cat("\n\n==================== ", label, " ====================\n")
  
  start <- grep("Coefficients", model_output)
  if (length(start) == 0) {
    cat("No coefficients found in output.\n")
    return()
  }
  
  end <- min(start + 10, length(model_output))
  cat(model_output[start:end], sep = "\n")
}
extract_model_summary(out_put_401, "ARIMA(4,0,1)")
```

```{r}
extract_model_summary(out_put_202, "ARIMA(2,0,2)")
```

Ultimately, I will choose ARIMA (4, 0, 1) as the best model because it has lower AIC and BIC values, suggesting that the model strikes a better balance between fitting the data and complexity.

### Further Modeling

The standardized residual plot of the above model diagnosis shows that the center of the residual fluctuation is around the 0 line, indicating that the ARIMA model fits the mean part better, and there is an obvious fluctuation aggregation phenomenon in the plot, and the fluctuation of the residuals suddenly and significantly increases at t=2600, so we need to further modeling

## GARCH Model Selection

```{r}
arima_duk_fit <- Arima(duk_return, order = c(4, 0, 1), include.drift = TRUE)

residuals_arima_duk <- residuals(arima_duk_fit)

acf(residuals_arima_duk, main = "ACF of ARIMA(4,0,1) Residuals")
```

```{r}
acf(residuals_arima_duk^2, main = "ACF of Squared Residuals")
```

```{r}
pacf(residuals_arima_duk^2, main = "PACF of Squared Residuals")
```

Based on the ACF and PACF plots of the residual squared term, the ACF shows a significant peak at lag1, followed by a slow decline, while the PACF shows significant peaks at lag1 and lag3.

The slow decay in the ACF indicates that the previous volatility affects the current volatility, there is volatility persistence, which is the feature captured by the GARCH model.

So it is better to use GARCH because it can model both abruptness and persistence of volatility. This will provide a more comprehensive fitting and forecasting capability than the ARCH model.

## Model Select

```{r}
models <- list()
cc<-1

for (p in 1:3) {
  models[[cc]] <- garch(residuals_arima_duk, order = c(1, p), trace = FALSE)
  cc <- cc + 1
 
  }
GARCH_AIC <- sapply(models, AIC)
best_index <- which.min(GARCH_AIC)
models[[best_index]]

cat("best model：GARCH(1,", best_index, ")\n")
```

We compared the AIC of all the models and according to the results it shows that GARCH (1, 1) is the best model because it has lower AIC and it can fit the data better compared to other models

## Final Model

```{r}
arima_fit_duk <- Arima(duk_return, order = c(4, 0, 1), include.drift = TRUE)
summary(arima_fit_duk)
```

```{r}
arima_res_duk<-residuals(arima_fit_duk)
final_fit_duk <- garchFit(~ garch(1, 1), data = arima_res_duk, trace = FALSE)
summary(final_fit_duk)
```

### Box Ljung test

```{r}
std_res <- residuals(final_fit_duk, standardize = TRUE)
Box.test(std_res, lag = 10, type = "Ljung-Box")

Box.test(std_res^2, lag = 10, type = "Ljung-Box")
```

The Box-Ljung test for standardized residuals gives a very small p-value (p = 3.717e-06), indicating that significant autocorrelation still exists in the residuals. The Box-Ljung test for the squared standardized residuals shows a large p-value (p = 0.9803) indicating that there is no significant autocorrelation in the squared residuals, which suggests that the GARCH(1,1) model is successful in capturing the aggregation effect of volatility (conditional heteroskedasticity) in the data, and that it is successful in modeling volatility. \## Equation

$$
x_t = 0.0003 - 0.8465 x_{t-1} + 0.0103 x_{t-2} + 0.0140 x_{t-3} - 0.0969 x_{t-4} + w_t + 0.7894 w_{t-1}
$$ $$
\sigma_t^2 = 3.0957 \times 10^{-6} + 0.072697 \cdot w_{t-1}^2 + 0.90288 \cdot \sigma_{t-1}^2
$$

## Forecast

```{r}
predict(final_fit_duk, n.ahead = 100, plot = TRUE)
```

# WTI

## Load data and visualization

```{r}
getSymbols("CL=F", from = start_date, to = end_date, src = "yahoo")
oil_price <- Cl(`CL=F`)
oil_return <- na.omit(dailyReturn(oil_price, type = "log"))

par(mfrow = c(1, 2))
plot(oil_price, main = "WTI Crude Oil Price (CL=F)", col = "darkgreen")
plot(oil_return, main = "WTI Oil Log Return", col = "blue")

roll_sd_oil <- rollapply(oil_return, width = 20, FUN = sd, by = 1, fill = NA)
plot(roll_sd_oil, main = "Rolling Volatility (WTI Crude Oil)", col = "darkgreen")

cat("ADF Test for WTI Oil Return:\n")
print(adf.test(na.omit(oil_return)))
```

The ADF test shows that the p-value is significantly less than 0.05 and the logarithmic yield series of WTI is smooth.

The raw price volatility was high, especially during the 2020 epidemic shock, and there were obvious structural fluctuations, but the price itself is not a smooth series.

The logarithmic yield plot shows that the volatility clustering has periods of very small returns and periods of sudden volatility, with very high amplitudes during the 2020 epidemic.

The rolling standard deviation plot shows significant changes in volatility over time, with volatility spiking to about 0.13 around 2020, much higher than the 0.02 \~ 0.05 in normal times, with significant conditional heteroskedasticity

## ACF & PACF

```{r}
par(mfrow = c(1, 2))
acf(na.omit(oil_return), main = "ACF of WTI Oil Return")
pacf(na.omit(oil_return), main = "PACF of WTI Oil Return")
```

According to ACF and PACF, we define p = 3, d = 0, q = 1

## ARIMA Model Selection

```{r}
ARIMA_c <- function(p_min, p_max, q_min, q_max, data) {
  results <- matrix(nrow = 0, ncol = 6)
  colnames(results) <- c("p", "d", "q", "AIC", "BIC", "AICc")
  
  for (p in p_min:p_max) {
    for (q in q_min:q_max) {
      d <- 0
      if ((p + d + q) <= 6) {
        fit <- tryCatch({
          Arima(na.omit(data), order = c(p, d, q))
        }, error = function(e) NULL)
        
        if (!is.null(fit)) {
          metrics <- c(p, d, q, AIC(fit), BIC(fit), fit$aicc)
          results <- rbind(results, metrics)
        }
      }
    }
  }
  
  results_df <- as.data.frame(results)
  colnames(results_df) <- c("p", "d", "q", "AIC", "BIC", "AICc")
  return(results_df)
}
output <- ARIMA_c(0, 5, 0, 5, data = oil_return)

output[which.min(output$AIC), ]
```

Based on the minimum AIC value, we get the best fitting model when ARIMA (1, 0, 4)

### auto.arima

```{r}
fit_auto_arima <- auto.arima(oil_return)
summary(fit_auto_arima)
```

ARIMA (1, 0, 1) at the best fitting model selected by Auto.arima \### Model Diagnotic

```{r}
library(astsa)
out_put_104 <- capture.output(sarima(oil_return, 1, 0, 4))
```

```{r}
out_put_101 <- capture.output(sarima(oil_return, 1, 0, 1))
```

### Compareation

```{r}
extract_model_summary <- function(model_output, label = "") {
  cat("\n\n==================== ", label, " ====================\n")
  
  start <- grep("Coefficients", model_output)
  if (length(start) == 0) {
    cat("No coefficients found in output.\n")
    return()
  }
  
  end <- min(start + 10, length(model_output))
  cat(model_output[start:end], sep = "\n")
}
extract_model_summary(out_put_104, "ARIMA(1,0,4)")
extract_model_summary(out_put_101, "ARIMA(1,0,1)")
```

Finally, I will choose ARIMA (1, 0, 4) as the best model because it has the lowest AIC and the coefficients are more significant

### Further Modeling

The standardized residual plots for the model ARIMA (1, 0, 4) show that residual fluctuations are significantly more dramatic in some intervals than in others, reflecting the phenomenon of fluctuation aggregation, and that although the ARIMA model captures the mean structure, the phenomenon of heteroskedasticity is still present in the residuals. The variance of the residuals varies over time and is not stable. There are characteristics of clustered large fluctuations alternating with periods of stability. We need further GARCH modeling

## GARCH Model

```{r}
arima_oil_fit <- Arima(oil_return, order = c(1, 0, 4), include.drift = TRUE)

residuals_arima_oil <- residuals(arima_oil_fit)

acf(residuals_arima_oil, main = "ACF of ARIMA(1,0,4) Residuals")
```

```{r}
acf(residuals_arima_oil^2, main = "ACF of Squared Residuals")
```

```{r}
pacf(residuals_arima_oil^2, main = "PACF of Squared Residuals")
```

Based on the ACF and PACF plots of the residual squared terms, the ACF shows a significant peak at lag 1, and the PACF shows significant peaks at la1 and lag 3. This indicates that there is a strong ARCH effect and fluctuation persistence in the data.

### Model Select

```{r}
models <- list()
cc<-1

for (p in 1:3) {
  models[[cc]] <- garch(residuals_arima_oil, order = c(1, p), trace = FALSE)
  cc <- cc + 1
 
  }
GARCH_AIC <- sapply(models, AIC)
best_index <- which.min(GARCH_AIC)
models[[best_index]]
cat("best model：GARCH(1,", best_index, ")\n")
```

Based on the results we know that the best model is GARCH (1, 1) because it has the smallest AIC and fits the data better compared to other models

## Final Model

```{r}
arima_fit_oil <- Arima(oil_return, order = c(1, 0, 4), include.drift = TRUE)
summary(arima_fit_oil)
```

```{r}
arima_res_oil<-residuals(arima_fit_oil)
final_fit_oil <- garchFit(~ garch(1, 1), data = arima_res_oil, trace = FALSE)
summary(final_fit_oil)
```

### Box-Ljung Test

```{r}
std_res <- residuals(final_fit_oil, standardize = TRUE)
Box.test(std_res, lag = 10, type = "Ljung-Box")

Box.test(std_res^2, lag = 10, type = "Ljung-Box")
```

The Box-Ljung test shows that there is still a slight autocorrelation in the standardized residuals of the model (p-value = 0.043), suggesting that there may be room for further optimization of the ARIMA mean equation. However, the squares of the standardized residuals are not significantly autocorrelated across lags (p-value = 0.642), indicating that the GARCH variance equation has successfully captured the conditional heteroskedasticity characteristics of the data. Thus, the model is effective in modeling volatility, the residual behavior is close to white noise, and the GARCH part performs well. \## Equation $$
x_t = 0.8957 x_{t-1} - 0.9047 \epsilon_{t-1} - 0.0104 \epsilon_{t-2} - 0.0638 \epsilon_{t-3} + 0.1020 \epsilon_{t-4} + \epsilon_t
$$

$$
\sigma_t^2 = 1.324 \times 10^{-5} + 0.1187 \cdot \epsilon_{t-1}^2 + 0.8618 \cdot \sigma_{t-1}^2
$$

## Forecast

```{r}
predict(final_fit_oil, n.ahead = 100, plot = TRUE)
```